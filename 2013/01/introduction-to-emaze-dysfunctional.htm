<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Mauro Rocchi's Blog - Introduction to Emaze Dysfunctional</title>
    <link rel="stylesheet" type="text/css" href="/css/pygments.css"/>
    <link rel="stylesheet" type="text/css" href="/css/theme.css"/>
    
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-38190103-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
</head>

<body>

<section id="container">
<article class="content">
    <header>
        <h1>Introduction to Emaze Dysfunctional</h1>
        <div class="meta">Written by <strong>Mauro Rocchi</strong> on 22 January 2013</div>
    </header>

    <p><a href="https://bitbucket.org/emaze/emaze-dysfunctional">Emaze Dysfunctional</a> is a Java library providing the support for the functional programming, released by <a href="http://emaze.net">Emaze Networks</a> under BSD license. Developed in accordance with <a href="http://en.wikipedia.org/wiki/SOLID_%28object-oriented_design%29">solid principles</a> of OOP, it's distinguished from other similar libraries for simplicity, robustness and high reusability of its components.</p>
<p>I will describe the main features of the current version 5.2 through some demonstrative examples, taken from the "classical" literature.</p>
<h2>Quicksort</h2>
<p>The following fragment implements the <a href="http://en.wikipedia.org/wiki/Quicksort">quicksort</a> algorithm, choosing, for simplicity, the first item as the pivot.</p>
<div class="codehilite"><pre><span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">quicksort</span><span class="o">(</span><span class="n">Iterator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">items</span><span class="o">,</span> <span class="n">BinaryPredicate</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">order</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">items</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">items</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">final</span> <span class="n">T</span> <span class="n">head</span> <span class="o">=</span> <span class="n">items</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
    <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">Consumers</span><span class="o">.</span><span class="na">all</span><span class="o">(</span><span class="n">items</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">Multiplexing</span><span class="o">.</span><span class="na">chain</span><span class="o">(</span>
            <span class="n">quicksort</span><span class="o">(</span><span class="n">Filtering</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">tail</span><span class="o">,</span> <span class="n">Dispatching</span><span class="o">.</span><span class="na">rcurry</span><span class="o">(</span><span class="n">order</span><span class="o">,</span> <span class="n">head</span><span class="o">)),</span> <span class="n">order</span><span class="o">),</span>
            <span class="n">Iterations</span><span class="o">.</span><span class="na">iterator</span><span class="o">(</span><span class="n">head</span><span class="o">),</span>
            <span class="n">quicksort</span><span class="o">(</span><span class="n">Filtering</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">tail</span><span class="o">,</span> <span class="n">Logic</span><span class="o">.</span><span class="na">not</span><span class="o">(</span><span class="n">Dispatching</span><span class="o">.</span><span class="na">rcurry</span><span class="o">(</span><span class="n">order</span><span class="o">,</span> <span class="n">head</span><span class="o">))),</span> <span class="n">order</span><span class="o">));</span>
<span class="o">}</span>
</pre></div>


<p>The function, in addition to the iterator with the items to sort, takes an argument of type <code>BinaryPredicate</code>, one of several <a href="http://en.wikipedia.org/wiki/Function_object">functors</a> provided by the library. It belong to the predicates family, that is those functions that return a boolean value. The "binary" prefix means that it's a predicate with ariety 2, infact it receives two values and retorns <em>true</em> if these are in order.</p>
<p>The available functors, intended to become your best friends, in order of arity (from 0 to 3) are: </p>
<ul>
<li><strong>Procedures</strong>: <code>java.lang.Runnable</code> (from the standard library), <code>Action</code>, <code>BinaryAction</code> e <code>TernaryAction</code>;</li>
<li><strong>Predicates</strong>: <code>Proposition</code>, <code>Predicate</code>, <code>BinaryPredicate</code>, <code>TernaryPredicate</code>;</li>
<li><strong>Generics</strong>: <code>Provider</code>, <code>Delegate</code>, <code>BinaryDelegate</code>, <code>TernaryDelegate</code>.</li>
</ul>
<p>As you can see a <code>QuadruplePredicate</code> doesn't exist, indeed <em>Dysfunctional</em> is developed following the <em>one, two, three, too many!</em> principle. If you need a fourth parameter, probably, or there are some design errors, or it could be the case of grouping related parameters into a container object.</p>
<!-- more -->

<p>Looking the function body it could observe the usage of the <code>Consumers</code> façade, that exposes useful methods to "consume" the elements of an iterator, iterable or array.
The code of <code>Consumers.all(items)</code> yields all elements remained of the iterator and inserts them in the output list.</p>
<p>The <code>Multiplexing</code> façade handles operations such as "many to one" or vice versa. In this case, <code>Multiplexing.chain(...)</code> returns an iterator that concatenates the three ones received.</p>
<p>Then, the quicksort gives back the elements lower than the pivot sorted recursively, the pivot, and the remaining elements, always sorted recursively. The selection of the elements lower than the pivot is carried out by the <code>Filtering.filter(tail, Dispatching.rcurry(order, head))</code> statement, which filters the list of objects holding the <code>Dispatching.rcurry(order, head)</code> predicate.</p>
<p>The <code>rcurry</code> method stands for "right curry", the <a href="http://www.haskell.org/haskellwiki/Partial_application">partial application </a> (not  <a href="http://www.haskell.org/haskellwiki/Currying">currying</a>) of <code>head</code> to the second argument of the <code>order</code> predicate. In practice, it returns a unary predicate equivalent to:</p>
<div class="codehilite"><pre><span class="k">new</span> <span class="n">Predicate</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;()</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">accept</span><span class="o">(</span><span class="n">T</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">order</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="n">head</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>After it's necessary to concatenate the pivot, and given that <code>chain</code> concatenates iterators I used <code>Iterations.iterator(head)</code> to create an iterator that provides only one element (one could achieve the same effect with <code>Arrays.asList(head).iterator()</code>, but so the code is more clear).</p>
<p>The third argument of the <code>chain</code> is similar to the first, but to get the remaining elements the predicate is inverted by the <code>Logic.not</code> method.</p>
<p>The function, finally, can be used in the following way:</p>
<div class="codehilite"><pre><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">sortingANonSortedList</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">BinaryPredicate</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">ascOrder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BinaryPredicate</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">accept</span><span class="o">(</span><span class="n">Integer</span> <span class="n">a</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">};</span>
    <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">sequence</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">6</span><span class="o">,</span> <span class="mi">9</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">7</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">8</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">sorted</span> <span class="o">=</span> <span class="n">Consumers</span><span class="o">.</span><span class="na">all</span><span class="o">(</span><span class="n">Quicksort</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">sequence</span><span class="o">.</span><span class="na">iterator</span><span class="o">(),</span> <span class="n">ascOrder</span><span class="o">));</span>
    <span class="n">Assert</span><span class="o">.</span><span class="na">assertArrayEquals</span><span class="o">(</span><span class="k">new</span> <span class="n">Integer</span><span class="o">[]{</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">6</span><span class="o">,</span> <span class="mi">7</span><span class="o">,</span> <span class="mi">8</span><span class="o">,</span> <span class="mi">9</span><span class="o">},</span> <span class="n">sorted</span><span class="o">.</span><span class="na">toArray</span><span class="o">());</span>
<span class="o">}</span>
</pre></div>


<h2>The N-queens problem</h2>
<p>The <a href="http://en.wikipedia.org/wiki/Eight_queens_puzzle">problem of the N-queens</a> is a classic puzzle that consists in placing N queens on a chessboard NxN without that they threaten each other. With languages ​​that natively support the functional constructs, like <a href="http://www.scala-lang.org/">Scala</a>, the problem can be solved with less than 10 lines of code (without loss of clarity), with Java of course it's a bit more tricky.
I propose the classic <a href="http://moritz.faui2k3.org/en/backtracking">backtracking algorithm</a>, developed with a functional object-oriented approach, using <em>Dysfunctional</em> extensively.</p>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="nf">queens</span><span class="o">(</span><span class="kt">int</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Pair</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">queenMoves</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span>
            <span class="n">Pair</span><span class="o">.</span><span class="na">of</span><span class="o">(-</span><span class="mi">1</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">),</span>
            <span class="n">Pair</span><span class="o">.</span><span class="na">of</span><span class="o">(-</span><span class="mi">1</span><span class="o">,</span> <span class="mi">0</span><span class="o">),</span>
            <span class="n">Pair</span><span class="o">.</span><span class="na">of</span><span class="o">(-</span><span class="mi">1</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
    <span class="kd">final</span> <span class="n">Mover</span> <span class="n">mover</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Mover</span><span class="o">(</span><span class="n">queenMoves</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">IsQueenSafe</span> <span class="n">isQueenSafe</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IsQueenSafe</span><span class="o">(</span><span class="n">mover</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">PlaceNextQueens</span> <span class="n">placeNextQueens</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PlaceNextQueens</span><span class="o">(</span><span class="n">isQueenSafe</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">Iterable</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">columns</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Ranges</span><span class="o">(</span><span class="k">new</span> <span class="n">ComparableComparator</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;(),</span> <span class="k">new</span> <span class="n">NextIntegerSequencingPolicy</span><span class="o">(),</span> <span class="mi">0</span><span class="o">).</span><span class="na">rightHalfOpen</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">Maybe</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="n">n</span><span class="o">));</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">PlaceQueens</span><span class="o">(</span><span class="n">Dispatching</span><span class="o">.</span><span class="na">curry</span><span class="o">(</span><span class="n">placeNextQueens</span><span class="o">,</span> <span class="n">columns</span><span class="o">)).</span><span class="na">perform</span><span class="o">(</span><span class="n">n</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>


<p>The <code>queens</code> method receives the board size and returns the list of the possible solutions (a solution is a list of integers, representing the configuration of the queens on the board), the body doesn't directly implement the algorithm, but rather it configures properly the components involved which then delegates the searching for solutions.</p>
<ul>
<li><code>Mover</code> is a binary function that, received the row and column where a queen is placed, returns a list of all the possible positions reachable from it (an iterator of pairs of row/column);</li>
<li><code>IsQueenSafe</code> is a predicate that, received the actual queens configuration and a column index, returns true if a queen placed in such column is safe (she isn't captured by any other queen);</li>
<li><code>PlaceNextQueens</code> is a binary function that, given a list of columns and the actual queens configuration, tries to add a queen on each column and returns the list of the configurations in which the new queen is safe;</li>
<li><code>PlaceQueens</code> is the function implementing the recursive search of the solutions.</li>
</ul>
<h3>Moving the queen</h3>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Mover</span> <span class="kd">implements</span> <span class="n">BinaryDelegate</span><span class="o">&lt;</span><span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Pair</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;,</span> <span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="c1">// iterable of pairs where the former is the row increment, and the latter is the column increment</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Iterable</span><span class="o">&lt;</span><span class="n">Pair</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">moves</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Mover</span><span class="o">(</span><span class="n">Iterable</span><span class="o">&lt;</span><span class="n">Pair</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">moves</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">moves</span> <span class="o">=</span> <span class="n">moves</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Pair</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="nf">perform</span><span class="o">(</span><span class="kd">final</span> <span class="n">Integer</span> <span class="n">row</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Integer</span> <span class="n">column</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">Multiplexing</span><span class="o">.</span><span class="na">chain</span><span class="o">(</span><span class="n">Applications</span><span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="n">moves</span><span class="o">,</span> <span class="k">new</span> <span class="n">Delegate</span><span class="o">&lt;</span><span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Pair</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;,</span> <span class="n">Pair</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Pair</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="nf">perform</span><span class="o">(</span><span class="n">Pair</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">move</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="k">new</span> <span class="n">MoveIterator</span><span class="o">(</span><span class="n">move</span><span class="o">,</span> <span class="n">row</span><span class="o">,</span> <span class="n">column</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>The object is initialized with a sequence of pairs, each of them represents a possible move of the piece (in terms of variation of the position of row/column). For example, the pair (-1, 0) enables the vertical moviment.<br />
The responsability for moving the pieace is delegated to the following <code>MoveIterator</code>, that is the only component with state of the whole algorithm. The iterator applies the variation of position relative to the current one, until all the space on the board is consumed.</p>
<p><code>Mover</code> uses a new function: <code>Applications.trasform</code>. It returns an iterator where the next element is obtained by applying the provided unary function to the original item, in other words it's the conventional <code>map</code> that operates over iterators in a lazy way.</p>
<p>The result is an iterator containing all the positions reachable from the queen.</p>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MoveIterator</span> <span class="kd">extends</span> <span class="n">ReadOnlyIterator</span><span class="o">&lt;</span><span class="n">Pair</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Pair</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">move</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">row</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">column</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">MoveIterator</span><span class="o">(</span><span class="n">Pair</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">move</span><span class="o">,</span> <span class="kt">int</span> <span class="n">row</span><span class="o">,</span> <span class="kt">int</span> <span class="n">column</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">move</span> <span class="o">=</span> <span class="n">move</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">column</span> <span class="o">=</span> <span class="n">column</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasNext</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">row</span> <span class="o">+</span> <span class="n">move</span><span class="o">.</span><span class="na">first</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="mi">0</span>
                <span class="o">&amp;&amp;</span> <span class="n">column</span> <span class="o">+</span> <span class="n">move</span><span class="o">.</span><span class="na">second</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Pair</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">row</span> <span class="o">+=</span> <span class="n">move</span><span class="o">.</span><span class="na">first</span><span class="o">();</span>
        <span class="n">column</span> <span class="o">+=</span> <span class="n">move</span><span class="o">.</span><span class="na">second</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">Pair</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">row</span><span class="o">,</span> <span class="n">column</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>Finally <code>MoveIterator</code> extends <code>ReadOnlyIterator</code>, an iterator that doesn't support the method <code>delete</code>.</p>
<h3>Is the queen safe?</h3>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">IsQueenSafe</span> <span class="kd">implements</span> <span class="n">BinaryPredicate</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">BinaryDelegate</span><span class="o">&lt;</span><span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Pair</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;,</span> <span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">mover</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">IsQueenSafe</span><span class="o">(</span><span class="n">BinaryDelegate</span><span class="o">&lt;</span><span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Pair</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;,</span> <span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">mover</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">mover</span> <span class="o">=</span> <span class="n">mover</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">accept</span><span class="o">(</span><span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">queens</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Integer</span> <span class="n">column</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">row</span> <span class="o">=</span> <span class="n">queens</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="kd">final</span> <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Pair</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">positions</span> <span class="o">=</span> <span class="n">mover</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">row</span><span class="o">,</span> <span class="n">column</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">Filtering</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">positions</span><span class="o">,</span> <span class="k">new</span> <span class="n">Predicate</span><span class="o">&lt;</span><span class="n">Pair</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">accept</span><span class="o">(</span><span class="n">Pair</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">queens</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">position</span><span class="o">.</span><span class="na">first</span><span class="o">())</span> <span class="o">==</span> <span class="n">position</span><span class="o">.</span><span class="na">second</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}).</span><span class="na">hasNext</span><span class="o">()</span> <span class="o">==</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>To check whether a queen is safe at a given location must "move" it and see if it meets another queen, so this component uses the <code>mover</code> collaborator to get all the possible reachable positions. Informally, the queen is in position <code>(row, column)</code> when <code>queens[row] == column</code>, therefore the predicate checks this situation.<br />
Note the use of the <code>hasNext</code> as a result of the function, which takes advantage lazy evaluation of iterators: the function returns <em>false</em> when it detects the first queen.</p>
<h3>Adding a queen</h3>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PlaceNextQueens</span> <span class="kd">implements</span> <span class="n">BinaryDelegate</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;,</span> <span class="n">Iterable</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">BinaryPredicate</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">isQueenSafe</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">PlaceNextQueens</span><span class="o">(</span><span class="n">BinaryPredicate</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">isQueenSafe</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">isQueenSafe</span> <span class="o">=</span> <span class="n">isQueenSafe</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="nf">perform</span><span class="o">(</span><span class="n">Iterable</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">columns</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">queens</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">safeColumns</span> <span class="o">=</span> <span class="n">Filtering</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">columns</span><span class="o">,</span> <span class="n">Dispatching</span><span class="o">.</span><span class="na">curry</span><span class="o">(</span><span class="n">isQueenSafe</span><span class="o">,</span> <span class="n">queens</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">Applications</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">safeColumns</span><span class="o">,</span> <span class="n">Dispatching</span><span class="o">.</span><span class="na">curry</span><span class="o">(</span><span class="k">new</span> <span class="n">AddToList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;(),</span> <span class="n">queens</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>It receives the actual configuration of the queens and a list of columns on which to try to place a new queen on the next row, and returns all the possible configurations in which the new queen is safe.<br />
To implement it in functional way I've used the functor <code>AddToList</code>, actually unavailable in <em>Dysfunctional</em>. Given a list and an element it returns a new list with the new item added.</p>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AddToList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">BinaryDelegate</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;,</span> <span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">perform</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">,</span> <span class="n">T</span> <span class="n">item</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;(</span><span class="n">list</span><span class="o">);</span>
        <span class="n">result</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">item</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>The list of columns is obtained generating through the façade <code>Ranges</code> an iterable from <code>0</code> to <code>n-1</code>:</p>
<div class="codehilite"><pre><span class="kd">final</span> <span class="n">Iterable</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">columns</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Ranges</span><span class="o">(</span>
    <span class="k">new</span> <span class="n">ComparableComparator</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;(),</span>
    <span class="k">new</span> <span class="n">NextIntegerSequencingPolicy</span><span class="o">(),</span>
    <span class="mi">0</span>
<span class="o">).</span><span class="na">rightHalfOpen</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">Maybe</span><span class="o">.</span><span class="na">just</span><span class="o">(</span><span class="n">n</span><span class="o">));</span>
</pre></div>


<h3>Finding all solutions</h3>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PlaceQueens</span> <span class="kd">implements</span> <span class="n">Delegate</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Delegate</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">placeNextQueens</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">PlaceQueens</span><span class="o">(</span><span class="n">Delegate</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">placeNextQueens</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">placeNextQueens</span> <span class="o">=</span> <span class="n">placeNextQueens</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="nf">perform</span><span class="o">(</span><span class="n">Integer</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="n">Collections</span><span class="o">.&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="n">emptyList</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">subQueens</span> <span class="o">=</span> <span class="n">perform</span><span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">Consumers</span><span class="o">.</span><span class="na">all</span><span class="o">(</span><span class="n">Multiplexing</span><span class="o">.</span><span class="na">flatten</span><span class="o">(</span><span class="n">Applications</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">subQueens</span><span class="o">,</span> <span class="n">placeNextQueens</span><span class="o">)));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p><code>PlaceQueens</code> is the heart of the backtracking algorithm. It delegates the adding of a new queen to the collaborator <code>placeNextQueens</code> and uses the method <code>Multiplexing.flatten</code> to flat the list of lists of boards in a list of boards.</p>
<h2>Conclusions</h2>
<p>In this article I shown in a nutshell how to use <em>Dysfunctional</em> to develop real-world Java application in a purely functional style. Some may think that the proposed solutions, in addition to being less efficient, are also unnecessarily more complex than the respective imperative versions. Those who know how important it is write clear, maintainable, flexible and testable, will be greatly appreciated.<br />
In my opinion, the beauty in the implementation of N-queens is that you can easily test not only the whole algorithm, but also its individual components independently. It is also easy to change the behavior (within certain limits) by simply configuring the components appropriately.<br />
For example, to change the way in which the queen moves is sufficient to provide a different set of possible moves, or reimplement the <code>Mover</code>; to work on a rectangular board just give a different set of columns at the <code>PlaceNextQueens</code>; you can reimplementing the manner in which the piece is considered safe; etc.</p>
<p>Of course there are many alternative libraries, I can quote <a href="http://functionaljava.org/">functionaljava</a>, <a href="http://code.google.com/p/guava-libraries/">guava</a>, <a href="http://code.google.com/p/lambdaj/">lambdaj</a>, <a href="http://www.fun4j.org/">fun4j</a> e <a href="http://code.google.com/p/totallylazy/">totallylazy</a>. </p>
<p>The choice is yours!</p>

    <!-- AddThis Button BEGIN -->
    <div class="addthis_toolbox addthis_default_style addthis_16x16_style">
    <a class="addthis_button_facebook"></a>
    <a class="addthis_button_twitter"></a>
    <a class="addthis_button_google_plusone_share"></a>
    <a class="addthis_button_email"></a>
    <a class="addthis_button_compact"></a><a class="addthis_counter addthis_bubble_style"></a>
    </div>
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5231b03d468cf7fd"></script>
    <!-- AddThis Button END -->
</article>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'maurocchi'; // required: replace example with your forum shortname
    var disqus_identifier = '/2013/01/introduction-to-emaze-dysfunctional.htm';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments</a>.</noscript>
</section>

<aside id="sidebar">
    <header>
        <h1><a href="/">Mauro Rocchi's Blog</a></h1>
        <h2>Programming in Action</h2>
    </header>

    <section class="pages">
        <h1>Pages</h1>
        <ul>
            <li><a href="/about.htm">About</a></li>
            <li><a xmlns:cc="http://creativecommons.org/ns#" href="https://github.com/maurocchi" property="cc:attributionName" rel="cc:attributionURL">Open source</a></li>
        </ul>
    </section>

    <section class="posts">
        <h1>Recent posts</h1>
        <ul>
            <li><a href="/2013/04/playing-with-haskell.htm">Playing with Haskell</a></li>
            <li><a href="/2013/02/monitoring-logs-with-sauron.htm">Monitoring logs with Sauron</a></li>
            <li><a href="/2013/01/introduction-to-emaze-dysfunctional.htm">Introduction to Emaze Dysfunctional</a></li>
        </ul>
    </section>

    <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
        <img alt="Creative Commons License" style="border-width:0" src="/images/license.png" />
    </a><br />
    <small>
    This content is distributed with 
    <a href="http://creativecommons.org/licenses/by-sa/4.0/">
    Creative Commons Attribution-ShareAlike 4.0 International Public License</a>.
    </small>
</aside>

</body>
</html>